<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NNITRO OS</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --bg: #ffffff; --panel: #f2f2f7; --text: #000; --accent: #007aff; --border: rgba(0,0,0,0.1); }
        .dark-mode { --bg: #000; --panel: #1c1c1e; --text: #fff; --border: rgba(255,255,255,0.1); }
        
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        #app { display: grid; grid-template-columns: 320px 1fr; height: 100vh; }
        
        /* Sidebar */
        #sidebar { background: var(--bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .search-area { padding: 15px; border-bottom: 1px solid var(--border); }
        .search-area input { width: 100%; padding: 10px; border-radius: 10px; border: none; background: var(--panel); color: var(--text); }
        
        .list-items { flex: 1; overflow-y: auto; }
        .item { padding: 12px 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .item:hover { background: var(--panel); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .online-dot { width: 10px; height: 10px; background: #34c759; border-radius: 50%; border: 2px solid var(--bg); position: absolute; bottom: 0; right: 0; }

        /* Chat */
        #chat { display: flex; flex-direction: column; background: var(--bg); }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .m { max-width: 70%; padding: 10px 15px; border-radius: 18px; font-size: 15px; }
        .m.in { align-self: flex-start; background: var(--panel); }
        .m.out { align-self: flex-end; background: var(--accent); color: #fff; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--bg); padding: 25px; border-radius: 20px; width: 300px; text-align: center; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
        .btn-blue { background: var(--accent); color: #white; }
        
        #vaad-admin { position: fixed; right: 20px; top: 70px; width: 350px; background: var(--bg); border: 1px solid var(--accent); border-radius: 15px; padding: 20px; display: none; z-index: 2000; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div style="width:300px; text-align:center;">
            <h1 style="font-size:40px; margin-bottom:20px;">NNITRO</h1>
            <input type="text" id="u-nick" placeholder="Username" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border);">
            <input type="password" id="u-pass" placeholder="Password (for VAaD)" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); margin-top:10px;">
            <button onclick="login()" class="btn" style="background:var(--accent); color:white;">ENTER</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div id="sidebar">
            <div class="search-area">
                <input type="text" id="search-inp" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." onkeyup="searchUsers(this.value)">
            </div>
            <div id="contacts-list" class="list-items">
                <div class="item" onclick="openChat('global', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç')">
                    <div class="avatar" style="background:#000;">G</div>
                    <b>–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</b>
                </div>
            </div>
            <div style="padding:15px;"><button class="btn" onclick="showGroupModal()">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button></div>
        </div>

        <div id="chat">
            <div class="chat-header">
                <span id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
                <button id="adm-btn" class="hidden" onclick="toggleVAaD()" style="background:none; border:none; font-size:20px; cursor:pointer;">‚öôÔ∏è</button>
            </div>
            <div id="messages"></div>
            <div style="padding:15px; display:flex; gap:10px; border-top:1px solid var(--border);">
                <button onclick="startVoice()" onmouseup="stopVoice()" id="mic" style="border:none; background:var(--panel); border-radius:50%; width:45px; height:45px; cursor:pointer;">üé§</button>
                <input type="text" id="m-inp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; padding:12px; border-radius:12px; border:none; background:var(--panel); color:var(--text);">
                <button onclick="send()" style="border:none; background:none; color:var(--accent); font-weight:bold; cursor:pointer;">SEND</button>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal" onclick="closeModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="avatar" id="m-avatar" style="width:80px; height:80px; margin:0 auto 15px; font-size:30px;">?</div>
            <h2 id="m-username">User</h2>
            <button class="btn btn-blue" onclick="startPrivate()">–ù–∞–ø–∏—Å–∞—Ç—å –õ–°</button>
            <button class="btn" style="background:#ff3b30; color:white;" onclick="blockUser()">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <div id="vaad-admin">
        <h3>VAaD CONTROL PANEL</h3>
        <p>–í–∏—Ä—É—Å: <span id="v-val">0</span>%</p>
        <button class="btn" onclick="runRoulette()" style="background:red; color:white;">–ó–ê–ü–£–°–¢–ò–¢–¨ –†–£–õ–ï–¢–ö–£</button>
        <hr>
        <h4>–Æ–∑–µ—Ä—ã –≤ –±–∞–∑–µ:</h4>
        <div id="admin-user-list" style="font-size:12px; text-align:left;"></div>
        <button class="btn" onclick="toggleVAaD()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAThHqr7jix2KbL7q9kc3JJ4_dMpn09q-o",
        authDomain: "nnitro-system.firebaseapp.com",
        databaseURL: "https://nnitro-system-default-rtdb.firebaseio.com",
        projectId: "nnitro-system"
    };
    firebase.initializeApp(firebaseConfig);
    const rdb = firebase.database();

    let myNick = "";
    let currentChatId = "";
    let selectedUser = "";
    let mediaRecorder, chunks = [];

    function login() {
        myNick = document.getElementById('u-nick').value.trim();
        let p = document.getElementById('u-pass').value;
        if(!myNick) return;

        if(myNick === "VAaD" && p === "zip123") document.getElementById('adm-btn').classList.remove('hidden');

        rdb.ref('users/' + myNick).set({ lastSeen: Date.now(), online: true });
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
        
        loadSidebar();
        listenVirus();
    }

    function loadSidebar() {
        rdb.ref('users').on('value', snap => {
            const list = document.getElementById('contacts-list');
            list.innerHTML = `<div class="item" onclick="openChat('global', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç')"><div class="avatar" style="background:#000;">G</div><b>–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</b></div>`;
            snap.forEach(u => {
                if(u.key !== myNick) {
                    list.innerHTML += `
                        <div class="item" onclick="showProfile('${u.key}')">
                            <div class="avatar">${u.key[0]}</div>
                            <div>
                                <b>${u.key}</b><br>
                                <small>${u.val().online ? '‚óè online' : 'offline'}</small>
                            </div>
                        </div>`;
                }
            });
        });
    }

    function showProfile(nick) {
        selectedUser = nick;
        document.getElementById('m-username').innerText = nick;
        document.getElementById('m-avatar').innerText = nick[0];
        document.getElementById('user-modal').style.display = 'flex';
    }

    function startPrivate() {
        const id = myNick < selectedUser ? `${myNick}_${selectedUser}` : `${selectedUser}_${myNick}`;
        openChat(id, `–õ–°: ${selectedUser}`);
        closeModals();
    }

    function openChat(id, title) {
        currentChatId = id;
        document.getElementById('chat-title').innerText = title;
        listenMessages();
    }

    function send() {
        const val = document.getElementById('m-inp').value;
        if(!val || !currentChatId) return;
        rdb.ref('msgs/' + currentChatId).push({ user: myNick, text: val, time: Date.now() });
        document.getElementById('m-inp').value = "";
    }

    function listenMessages() {
        rdb.ref('msgs/' + currentChatId).limitToLast(50).on('value', snap => {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            snap.forEach(c => {
                const d = c.val();
                box.innerHTML += `<div class="m ${d.user === myNick ? 'out' : 'in'}"><b>${d.user}</b><br>${d.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    function toggleVAaD() {
        const p = document.getElementById('vaad-admin');
        const show = p.style.display !== 'block';
        p.style.display = show ? 'block' : 'none';
        if(show) {
            rdb.ref('users').once('value', snap => {
                let html = "";
                snap.forEach(u => { html += `<div>${u.val().online ? 'üü¢' : '‚ö™'} ${u.key}</div>`; });
                document.getElementById('admin-user-list').innerHTML = html;
            });
        }
    }

    function listenVirus() {
        rdb.ref('system/virus').on('value', s => {
            const v = s.val() || 0;
            document.getElementById('v-val').innerText = Math.floor(v);
            if(v >= 51) document.body.style.filter = "invert(1) hue-rotate(180deg)";
        });
    }

    function runRoulette() {
        rdb.ref('users').once('value', s => {
            const users = Object.keys(s.val());
            const v = users[Math.floor(Math.random()*users.length)];
            rdb.ref('system/infected_user').set(v);
            alert("–ù—É–ª–µ–≤–æ–π –ø–∞—Ü–∏–µ–Ω—Ç: " + v);
        });
    }

    async function startVoice() {
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.start();
    }
    function stopVoice() {
        mediaRecorder.stop();
        mediaRecorder.onstop = () => {
            const reader = new FileReader();
            reader.readAsDataURL(new Blob(chunks));
            reader.onloadend = () => {
                rdb.ref('msgs/'+currentChatId).push({ user:myNick, text:`<audio controls src="${reader.result}"></audio>`, time:Date.now() });
            };
        };
    }

    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
</script>
</body>
</html>
