<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NNITRO OS</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --neon: #00ff41; /* Кислотно-зеленый */
            --bg: #050505;
            --panel: #0d0d0d;
            --virus: #ff003c;
        }

        * { box-sizing: border-box; font-family: 'JetBrains Mono', monospace; }
        body { margin: 0; background: var(--bg); color: var(--neon); height: 100vh; overflow: hidden; }

        /* Дизайн чата */
        #app { display: flex; height: 100vh; border: 2px solid #111; }
        
        #sidebar { width: 300px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; }
        #chat-area { flex: 1; display: flex; flex-direction: column; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); }

        .header { padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }

        /* Сообщения */
        .m { max-width: 80%; padding: 12px; position: relative; border: 1px solid #222; background: rgba(0,0,0,0.5); }
        .m.out { align-self: flex-end; border-color: var(--neon); background: rgba(0, 255, 65, 0.05); }
        .m.in { align-self: flex-start; border-color: #444; }
        .m b { display: block; font-size: 0.7em; margin-bottom: 5px; opacity: 0.6; }

        /* Ввод */
        .controls { padding: 15px; background: var(--panel); border-top: 1px solid #222; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; background: #000; border: 1px solid #333; padding: 12px; color: var(--neon); outline: none; }
        input:focus { border-color: var(--neon); }

        /* Кнопка записи */
        #mic-btn { 
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--neon); 
            background: none; color: var(--neon); cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        #mic-btn.active { background: var(--virus); border-color: white; color: white; box-shadow: 0 0 15px var(--virus); }

        /* Админка */
        #admin-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; 
            display: none; align-items: center; justify-content: center; 
        }
        .admin-box { width: 400px; padding: 30px; border: 2px solid gold; background: #000; }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            #sidebar { display: none; }
            .m { max-width: 90%; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; z-index:1000; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="font-size: 3em; text-shadow: 0 0 10px var(--neon);">NNITRO-2026</h1>
        <div style="width: 300px; display:flex; flex-direction:column; gap:10px;">
            <input type="text" id="u-nick" placeholder="USER_ID">
            <input type="password" id="u-pass" placeholder="PASSWORD">
            <button onclick="login()" style="padding:15px; background:var(--neon); color:#000; font-weight:bold; border:none; cursor:pointer;">CONNECT</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div id="sidebar">
            <div class="header">
                <span id="my-name">ADMIN</span>
                <button id="adm-btn" class="hidden" onclick="showAdmin(true)" style="background:gold; border:none; cursor:pointer;">VAaD</button>
            </div>
            <div style="padding:15px; font-size:0.8em; opacity:0.5;">ACTIVE_CHANNELS:</div>
            <div style="padding:15px; background:#111; cursor:pointer;"># GLOBAL_MAIN</div>
        </div>

        <div id="chat-area">
            <div class="header">CHANNEL: //GLOBAL_MAIN</div>
            <div id="messages"></div>
            <div class="controls">
                <button id="mic-btn">REC</button>
                <input type="text" id="msg-inp" placeholder="WAITING FOR INPUT..." onkeypress="if(event.key==='Enter') sendText()">
                <button onclick="sendText()" style="padding:12px; background:none; border:1px solid var(--neon); color:var(--neon); cursor:pointer;">SEND</button>
            </div>
        </div>
    </div>

    <div id="admin-modal">
        <div class="admin-box">
            <h2 style="color:gold;">VAaD SYSTEM OVERRIDE</h2>
            <div id="virus-status">VIRUS_LEVEL: 0%</div>
            <button onclick="startVirus()" style="width:100%; padding:15px; background:var(--virus); color:white; border:none; margin-top:10px; cursor:pointer;">EXECUTE VIRUS.EXE</button>
            <button onclick="showAdmin(false)" style="width:100%; margin-top:10px; background:#333; color:white; border:none; padding:10px; cursor:pointer;">EXIT</button>
        </div>
    </div>

    <script>
        // Твои ключи
        const firebaseConfig = {
            apiKey: "AIzaSyAThHqr7jix2KbL7q9kc3JJ4_dMpn09q-o",
            authDomain: "nnitro-system.firebaseapp.com",
            databaseURL: "https://nnitro-system-default-rtdb.firebaseio.com",
            projectId: "nnitro-system",
            storageBucket: "nnitro-system.firebasestorage.app"
        };

        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let userNick = "";
        let mediaRecorder;
        let audioChunks = [];

        function login() {
            userNick = document.getElementById('u-nick').value;
            const pass = document.getElementById('u-pass').value;
            if(!userNick) return alert("EMPTY ID");

            if(userNick === "VAaD" && pass === "zip123") {
                document.getElementById('adm-btn').classList.remove('hidden');
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('my-name').innerText = userNick;

            listenMsgs();
            listenVirus();
        }

        // ОТПРАВКА ТЕКСТА
        function sendText() {
            const inp = document.getElementById('msg-inp');
            if(!inp.value) return;
            rdb.ref('msgs').push({
                user: userNick,
                text: inp.value,
                type: 'text',
                time: Date.now()
            });
            inp.value = "";
        }

        // РАБОТА С ГОЛОСОМ (ФИКС)
        const micBtn = document.getElementById('mic-btn');

        micBtn.onmousedown = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    // Конвертируем в Base64 чтобы точно отправилось
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64data = reader.result;
                        rdb.ref('msgs').push({
                            user: userNick,
                            audio: base64data,
                            type: 'voice',
                            time: Date.now()
                        });
                    };
                };

                mediaRecorder.start();
                micBtn.classList.add('active');
                micBtn.innerText = "LIVE";
            } catch (err) {
                alert("МИКРОФОН ЗАБЛОКИРОВАН В БРАУЗЕРЕ!");
            }
        };

        micBtn.onmouseup = () => {
            if(mediaRecorder) {
                mediaRecorder.stop();
                micBtn.classList.remove('active');
                micBtn.innerText = "REC";
            }
        };

        // СЛУШАЕМ СООБЩЕНИЯ
        function listenMsgs() {
            rdb.ref('msgs').limitToLast(20).on('value', snap => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    const side = d.user === userNick ? 'out' : 'in';
                    let content = d.type === 'text' ? d.text : `<audio controls src="${d.audio}"></audio>`;
                    box.innerHTML += `<div class="m ${side}"><b>${d.user}</b>${content}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // АДМИНКА И ВИРУС
        function showAdmin(s) { document.getElementById('admin-modal').style.display = s ? 'flex' : 'none'; }

        function startVirus() {
            let v = 0;
            const i = setInterval(() => {
                v += 5;
                rdb.ref('system/virus').set(v);
                if(v >= 100) clearInterval(i);
            }, 500);
        }

        function listenVirus() {
            rdb.ref('system/virus').on('value', snap => {
                const v = snap.val() || 0;
                document.getElementById('virus-status').innerText = `VIRUS_LEVEL: ${v}%`;
                if(v >= 51) {
                    document.body.style.filter = "invert(1) hue-rotate(90deg) blur(1px)";
                    document.body.style.transform = "skewX(1deg)";
                }
            });
        }
    </script>
</body>
</html>
