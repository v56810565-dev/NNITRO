<button onclick="sendGlobalAlert()" style="background:orange; color:black;">GLOBAL ALERT</button>

<button onclick="toggleIgnore()" id="ignore-btn" style="border:none; background:none; font-size:12px; color:red;">[–ë–õ–û–ö]</button>

<script>
    // --- 1. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –û–ü–û–í–ï–©–ï–ù–ò–ï (–¢–æ–ª—å–∫–æ –¥–ª—è VAAD) ---
    function sendGlobalAlert() {
        const txt = prompt("–¢–ï–ö–°–¢ –û–ü–û–í–ï–©–ï–ù–ò–Ø –î–õ–Ø –í–°–ï–•:");
        if (!txt) return;
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É
        db.ref('system/alert').set({
            msg: txt,
            from: 'SYSTEM / VAAD',
            ts: Date.now()
        });
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–π (–¥–ª—è –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤)
    function listenAlerts() {
        db.ref('system/alert').on('value', s => {
            const data = s.val();
            if (data && data.ts > (Date.now() - 10000)) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ–∫)
                alert("üì¢ –í–ù–ò–ú–ê–ù–ò–ï –û–¢ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–ò:\n\n" + data.msg);
            }
        });
    }

    // --- 2. –õ–ò–ß–ù–´–ô –ò–ì–ù–û–† (–ß–ï–†–ù–´–ô –°–ü–ò–°–û–ö) ---
    function toggleIgnore() {
        const isIgnored = my.blacklist && my.blacklist[cur];
        if (confirm(isIgnored ? `–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${cur}?` : `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${cur}?`)) {
            db.ref(`users/${my.n}/blacklist/${cur}`).set(isIgnored ? null : true);
            alert("–ì–û–¢–û–í–û");
        }
    }

    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏–≥–Ω–æ—Ä–∞
    async function send(type = 't', val = null) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∑–∞–º—É—á–µ–Ω –ª–∏ —è –∞–¥–º–∏–Ω–æ–º
        const myData = await db.ref(`users/${my.n}`).once('value');
        if (myData.val().muted) return alert("–£ –í–ê–° –ú–£–¢");

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ª–∏ –º–µ–Ω—è –ø–æ–ª—É—á–∞—Ç–µ–ª—å (cur)
        if (cur !== 'GLOBAL_GROUP') {
            const targetData = await db.ref(`users/${cur}/blacklist/${my.n}`).once('value');
            if (targetData.exists()) return alert("–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –í–ê–° –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–õ");
        }

        const i = document.getElementById('m-in');
        const content = val || i.value.trim();
        if (!content) return;

        const room = cur === 'GLOBAL_GROUP' ? 'GLOBAL_GROUP' : [my.n, cur].sort().join('_');
        db.ref('msgs/' + room).push({ u: my.n, t: content, type: type });
        i.value = '';
    }

    // --- 3. –ì–†–£–ü–ü–û–í–´–ï –ß–ê–¢–´ ---
    // –í draw() —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ–º "–û–ë–©–ò–ô –ß–ê–¢" –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
    function draw() {
        const box = document.getElementById('list'); box.innerHTML = '';
        
        // –ö–Ω–æ–ø–∫–∞ –æ–±—â–µ–≥–æ —á–∞—Ç–∞
        box.innerHTML += `
            <div class="item" onclick="openChat('GLOBAL_GROUP', 'üåê')" style="background:#eefaff; border:1px solid #007aff;">
                <div class="ava-ring">üåê</div>
                <b>–û–ë–©–ò–ô –ß–ê–¢ (GROUP)</b>
            </div>`;

        Object.values(users).forEach(u => {
            if (u.n === my.n) return;
            box.innerHTML += `
                <div class="item" onclick="openChat('${u.n}', '${u.e}')">
                    <div class="ava-ring">${u.e}</div>
                    <b>${u.n}</b>
                </div>`;
        });
    }

    // –í–∫–ª—é—á–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∫—É –∞–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    // (–í—ã–∑—ã–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ showApp –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ auth)
    listenAlerts();

</script>
