<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NNITRO Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg: #ffffff;
            --panel: #f2f2f7;
            --text: #000000;
            --accent: #007aff;
            --msg-in: #e9e9eb;
            --msg-out: #007aff;
            --border: rgba(0,0,0,0.1);
        }

        .dark-mode {
            --bg: #000000;
            --panel: #1c1c1e;
            --text: #ffffff;
            --msg-in: #3a3a3c;
            --msg-out: #0a84ff;
            --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; transition: background 0.3s, filter 0.5s; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #auth-screen {
            position: fixed; inset: 0; z-index: 9999; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .auth-card { width: 320px; text-align: center; }
        .auth-card h1 { font-size: 32px; font-weight: 800; margin-bottom: 20px; letter-spacing: -1px; }
        input { 
            width: 100%; padding: 14px; margin: 10px 0; border: none; 
            background: var(--panel); border-radius: 12px; color: var(--text); outline: none; font-size: 16px;
        }
        .btn-connect { 
            width: 100%; padding: 14px; background: var(--accent); color: white; 
            border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }

        /* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #app { display: grid; grid-template-columns: 350px 1fr; height: 100vh; }
        #sidebar { background: var(--bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        #chat-window { display: flex; flex-direction: column; background: var(--bg); position: relative; }

        .header { 
            height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border); font-weight: 700; font-size: 18px;
        }

        /* –°–ü–ò–°–û–ö –ß–ê–¢–û–í */
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { 
            padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 12px; 
            cursor: pointer; margin-bottom: 5px;
        }
        .chat-item:hover { background: var(--panel); }
        .chat-item.active { background: rgba(0, 122, 255, 0.1); }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: #ccc; flex-shrink: 0; }

        /* –û–ö–ù–û –°–û–û–ë–©–ï–ù–ò–ô */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 16px; border-radius: 20px; font-size: 16px; line-height: 1.4; position: relative; }
        .msg.in { align-self: flex-start; background: var(--msg-in); color: var(--text); border-bottom-left-radius: 4px; }
        .msg.out { align-self: flex-end; background: var(--msg-out); color: #fff; border-bottom-right-radius: 4px; }
        .msg b { display: block; font-size: 11px; opacity: 0.5; margin-bottom: 2px; }

        /* –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê */
        .input-bar { padding: 15px 20px; display: flex; align-items: center; gap: 12px; border-top: 1px solid var(--border); }
        .mic-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--panel); cursor: pointer; font-size: 20px; }
        .mic-btn.active { background: #ff3b30; color: white; animation: pulse 1s infinite; }

        /* –°–ö–†–´–¢–ê–Ø –ê–î–ú–ò–ù–ö–ê */
        #vaad-panel {
            position: fixed; top: 70px; right: 20px; width: 260px; background: var(--panel);
            border-radius: 16px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 5000; display: none; border: 1px solid var(--accent);
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        @media (max-width: 768px) { #app { grid-template-columns: 1fr; } #sidebar { display: none; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h1>NNITRO</h1>
            <input type="text" id="u-nick" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="u-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-connect" onclick="connect()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div id="sidebar">
            <div class="header">–ß–∞—Ç—ã</div>
            <div class="chat-list">
                <div class="chat-item active" onclick="switchChat('global')">
                    <div class="chat-avatar" style="background: var(--accent); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 800;">G</div>
                    <div><b>–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</b><br><small style="opacity:0.6">NNITRO Community</small></div>
                </div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border);">
                <button onclick="document.body.classList.toggle('dark-mode')" style="width: 100%; padding: 10px; border-radius: 10px; border: none; background: var(--panel); color: var(--text); cursor: pointer;">üåì –¢–µ–º–∞</button>
            </div>
        </div>

        <div id="chat-window">
            <div class="header">
                <span id="current-chat-name">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</span>
                <button id="vaad-gear" class="hidden" onclick="toggleAdmin()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚öôÔ∏è</button>
            </div>
            <div id="messages"></div>
            <div class="input-bar">
                <button class="mic-btn" id="mic-btn" onmousedown="startVoice()" onmouseup="stopVoice()">üé§</button>
                <input type="text" id="msg-input" placeholder="C–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" style="background: none; border: none; color: var(--accent); font-weight: 700; cursor: pointer;">–û–¢–ü–†–ê–í–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <div id="vaad-panel">
        <h3 style="margin-top:0">–°–∏—Å—Ç–µ–º–∞ VAaD</h3>
        <p style="font-size:12px; opacity:0.7">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–¥–µ–º–∏–µ–π:</p>
        <div style="background:#ddd; height:8px; border-radius:4px; overflow:hidden; margin-bottom:10px;">
            <div id="v-progress" style="width:0%; height:100%; background:#ff3b30; transition: 0.3s;"></div>
        </div>
        <p style="font-size:11px;">–ó–∞—Ä–∞–∂–µ–Ω–∏–µ: <span id="v-status">0</span>%</p>
        <button class="btn-connect" onclick="runRoulette()" style="font-size:12px; padding:8px;">üé∞ –ó–ê–ü–£–°–¢–ò–¢–¨ –†–£–õ–ï–¢–ö–£</button>
        <button class="btn-connect" style="background:#555; font-size:12px; padding:8px;" onclick="toggleAdmin()">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAThHqr7jix2KbL7q9kc3JJ4_dMpn09q-o",
            authDomain: "nnitro-system.firebaseapp.com",
            databaseURL: "https://nnitro-system-default-rtdb.firebaseio.com",
            projectId: "nnitro-system",
            storageBucket: "nnitro-system.firebasestorage.app"
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let myNick = "";
        let currentChat = "global";
        let mediaRecorder;
        let chunks = [];

        function connect() {
            myNick = document.getElementById('u-nick').value.trim();
            const pass = document.getElementById('u-pass').value.trim();
            if(!myNick) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞
            if(myNick === "VAaD" && pass === "zip123") {
                document.getElementById('vaad-gear').classList.remove('hidden');
            }

            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');

            rdb.ref('users/' + myNick).set({ status: 'online' });
            listenMsgs();
            listenVirus();
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if(!inp.value) return;

            // –¢–∏—Ö–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ
            rdb.ref('system/infected_user').once('value', s => {
                if(s.val() === myNick) {
                    rdb.ref('system/virus').transaction(v => (v || 0) + 0.5);
                }
            });

            rdb.ref('msgs/' + currentChat).push({
                user: myNick,
                text: inp.value,
                type: 'text',
                time: Date.now()
            });
            inp.value = "";
        }

        function listenMsgs() {
            rdb.ref('msgs/' + currentChat).limitToLast(50).on('value', snap => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    const side = d.user === myNick ? 'out' : 'in';
                    const content = d.type === 'text' ? d.text : `<audio controls src="${d.data}"></audio>`;
                    box.innerHTML += `<div class="msg ${side}"><b>${d.user}</b>${content}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function listenVirus() {
            rdb.ref('system/virus').on('value', s => {
                const v = s.val() || 0;
                if(myNick === "VAaD") {
                    document.getElementById('v-progress').style.width = v + "%";
                    document.getElementById('v-status').innerText = Math.floor(v);
                }
                
                // –°–∫—Ä—ã—Ç–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                if(v >= 40) document.body.style.filter = `saturate(${1 + v/100})`;
                if(v >= 51) {
                    document.body.style.filter = "invert(1) hue-rotate(180deg) contrast(1.1)";
                    if(myNick !== "VAaD") {
                        document.getElementById('current-chat-name').innerText = "FATAL ERROR: VIRUS_DETECTED";
                    }
                }
            });
        }

        // --- –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ---
        async function startVoice() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.start();
                document.getElementById('mic-btn').classList.add('active');
            } catch(e) { alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); }
        }

        function stopVoice() {
            if(!mediaRecorder || mediaRecorder.state === 'inactive') return;
            mediaRecorder.stop();
            document.getElementById('mic-btn').classList.remove('active');
            mediaRecorder.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks, { type: 'audio/webm' }));
                reader.onloadend = () => {
                    rdb.ref('msgs/' + currentChat).push({
                        user: myNick,
                        data: reader.result,
                        type: 'voice',
                        time: Date.now()
                    });
                };
            };
        }

        function toggleAdmin() {
            const p = document.getElementById('vaad-panel');
            p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        }

        function runRoulette() {
            rdb.ref('msgs/global').once('value', s => {
                const users = [];
                s.forEach(m => { if(!users.includes(m.val().user)) users.push(m.val().user); });
                if(users.length === 0) return alert("–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤!");
                const victim = users[Math.floor(Math.random() * users.length)];
                rdb.ref('system/infected_user').set(victim);
                alert("–û–±—ä–µ–∫—Ç " + victim + " –∑–∞—Ä–∞–∂–µ–Ω. –¢–∏—Ö–∞—è —Ñ–∞–∑–∞ –Ω–∞—á–∞–ª–∞—Å—å.");
            });
        }
    </script>
</body>
</html>
